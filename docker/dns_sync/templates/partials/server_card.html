<div id="card-{{ server.name }}"
     class="bg-gray-800 rounded-lg border border-gray-700 shadow flex flex-col
            {% if not server.get('enabled', true) %}opacity-50{% endif %}">

  <!-- Card header -->
  <div class="flex items-start justify-between px-4 pt-4 pb-3 border-b border-gray-700">
    <div class="flex items-center gap-2 min-w-0">
      <!-- Status dot -->
      {% set ls = server.last_sync %}
      {% if not server.get('enabled', true) %}
        <span class="w-2 h-2 rounded-full bg-gray-600 flex-shrink-0" title="Disabled"></span>
      {% elif ls and ls.status == 'success' %}
        <span class="w-2 h-2 rounded-full bg-green-500 flex-shrink-0" title="Last sync succeeded"></span>
      {% elif ls and ls.status == 'error' %}
        <span class="w-2 h-2 rounded-full bg-red-500 flex-shrink-0" title="Last sync failed"></span>
      {% else %}
        <span class="w-2 h-2 rounded-full bg-gray-500 flex-shrink-0" title="Never synced"></span>
      {% endif %}

      <span class="font-semibold text-white text-sm truncate">{{ server.name }}</span>
    </div>

    <div class="flex items-center gap-1.5 flex-shrink-0 ml-2">
      {% if not server.get('enabled', true) %}
      <span class="px-1.5 py-0.5 rounded text-xs font-medium bg-gray-700 text-gray-400 uppercase tracking-wide">
        disabled
      </span>
      {% endif %}
      <span class="px-1.5 py-0.5 rounded text-xs font-medium bg-blue-900/50 text-blue-300 uppercase tracking-wide">
        {{ server.type }}
      </span>
    </div>
  </div>

  <!-- Card body -->
  <div class="px-4 py-3 flex-1 text-sm">
    {% if server.sync_mode == 'hub' %}
      <!-- Hub: show cache state -->
      {% if server.cache_last_updated %}
        <p class="text-green-400 font-medium flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75M3.75 13.875v3.75"/>
          </svg>
          Cache active
        </p>
        <p class="text-gray-500 text-xs mt-1.5">
          Last refreshed:
          <span data-ts="{{ server.cache_last_updated }}"
                title="{{ server.cache_last_updated[:19] | replace('T', ' ') }} UTC"
                class="text-gray-400"></span>
        </p>
        <p class="text-gray-400 text-xs mt-1 flex gap-3">
          <span><span class="text-white font-medium">{{ server.cache_record_counts.get('A', 0) }}</span> A records</span>
          <span><span class="text-white font-medium">{{ server.cache_record_counts.get('CNAME', 0) }}</span> CNAME records</span>
        </p>
      {% else %}
        <p class="text-yellow-400 font-medium flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"/>
          </svg>
          No cache â€” refresh needed
        </p>
      {% endif %}
    {% else %}
      <!-- Spoke: sync status badge -->

      {% if not server.get('enabled', true) %}
        <p class="text-gray-500 font-medium flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636"/>
          </svg>
          Disabled
        </p>
      {% elif ls and ls.status == 'success' %}
        <p class="text-green-400 font-medium flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5"/>
          </svg>
          Synced
        </p>
      {% elif ls and ls.status == 'error' %}
        <p class="text-red-400 font-medium flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"/>
          </svg>
          Error
        </p>
      {% else %}
        <p class="text-gray-500 font-medium flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
          </svg>
          Never synced
        </p>
      {% endif %}

      {% if server.spoke_record_counts %}
        <p class="text-gray-400 text-xs mt-2 flex gap-3">
          <span><span class="text-white font-medium">{{ server.spoke_record_counts.get('A', 0) }}</span> A records</span>
          <span><span class="text-white font-medium">{{ server.spoke_record_counts.get('CNAME', 0) }}</span> CNAME records</span>
        </p>
      {% endif %}

      {% if ls %}
        <p class="text-gray-500 text-xs mt-1.5">
          Last sync:
          <span data-ts="{{ ls.started_at }}"
                title="{{ ls.started_at[:19] | replace('T', ' ') }} UTC"
                class="text-gray-400"></span>
        </p>
        {% if ls.status == 'error' %}
          <details class="mt-1 group">
            <summary class="text-red-400 text-xs cursor-pointer list-none flex items-center gap-1.5
                            hover:text-red-300 transition-colors">
              <svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
              </svg>
              <span class="truncate">{{ ls.error | truncate(55) }}</span>
            </summary>
            <p class="mt-1.5 text-gray-400 text-xs leading-relaxed break-words">{{ ls.error }}</p>
          </details>
        {% endif %}
      {% endif %}
    {% endif %}
  </div>

  <!-- Card footer -->
  <div class="px-4 pb-4 pt-3 border-t border-gray-700 flex gap-2">
    {% if server.sync_mode == 'hub' %}
      <!-- Hub: Refresh Hub button -->
      <button
        hx-post="/api/hub/refresh"
        hx-target="#card-{{ server.name }}"
        hx-swap="outerHTML"
        hx-disabled-elt="this"
        class="flex-1 flex items-center justify-center gap-1.5 bg-blue-600 hover:bg-blue-500
               active:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed
               text-white text-xs font-medium rounded-md px-3 py-1.5
               transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
               focus:ring-offset-gray-800">
        <span class="htmx-indicator" role="status" aria-label="Refreshing hub cache...">
          <svg class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
          </svg>
        </span>
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99"/>
        </svg>
        <span>Refresh Hub</span>
      </button>
    {% else %}
      <!-- Spoke: Sync / Toggle / Remove -->
      {% if server.get('enabled', true) %}
      <button
        hx-post="/api/sync/{{ server.name }}"
        hx-target="#card-{{ server.name }}"
        hx-swap="outerHTML"
        hx-disabled-elt="this"
        class="flex-1 flex items-center justify-center gap-1.5 bg-blue-600 hover:bg-blue-500
               active:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed
               text-white text-xs font-medium rounded-md px-3 py-1.5
               transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
               focus:ring-offset-gray-800">
        <span class="htmx-indicator" role="status" aria-label="Syncing...">
          <svg class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
          </svg>
        </span>
        <span>Sync</span>
      </button>
      {% endif %}

      <button
        hx-post="/api/servers/{{ server.name }}/toggle"
        hx-target="#card-{{ server.name }}"
        hx-swap="outerHTML"
        class="flex-shrink-0 text-xs font-medium rounded-md px-3 py-1.5 transition-colors
               focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800
               {% if server.get('enabled', true) %}
                 bg-gray-700 hover:bg-gray-600 text-gray-300 focus:ring-gray-500
               {% else %}
                 bg-green-700 hover:bg-green-600 text-white focus:ring-green-500
               {% endif %}">
        {{ "Enable" if not server.get('enabled', true) else "Disable" }}
      </button>

      {% if server.get('enabled', true) and server.spoke_record_counts %}
      <button
        hx-post="/api/servers/{{ server.name }}/clear-records"
        hx-target="#card-{{ server.name }}"
        hx-swap="outerHTML"
        hx-confirm="Clear all DNS records from {{ server.name }}?"
        hx-disabled-elt="this"
        title="Clear all records from this spoke"
        class="flex-shrink-0 bg-gray-700 hover:bg-orange-900/60 text-gray-400 hover:text-orange-300
               disabled:opacity-50 disabled:cursor-not-allowed
               text-xs font-medium rounded-md px-2.5 py-1.5 transition-colors
               focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2
               focus:ring-offset-gray-800">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75 14.25 12m0 0 2.25 2.25M14.25 12l2.25-2.25M14.25 12 12 14.25m-2.58 4.92-6.374-6.375a1.125 1.125 0 0 1 0-1.59L9.42 4.83c.21-.211.497-.33.795-.33H19.5a2.25 2.25 0 0 1 2.25 2.25v10.5a2.25 2.25 0 0 1-2.25 2.25h-9.284c-.298 0-.585-.119-.795-.33Z"/>
        </svg>
      </button>
      {% endif %}

      <button
        hx-delete="/api/servers/{{ server.name }}"
        hx-target="#card-{{ server.name }}"
        hx-swap="outerHTML"
        hx-confirm="Remove {{ server.name }}?"
        aria-label="Remove {{ server.name }}"
        class="flex-shrink-0 bg-gray-700 hover:bg-red-900/60 text-gray-400 hover:text-red-300
               text-xs font-medium rounded-md px-2.5 py-1.5 transition-colors
               focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2
               focus:ring-offset-gray-800">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
        </svg>
      </button>
    {% endif %}
  </div>
</div>
