<!-- Filter controls + table — full partial returned by /api/history -->
<div class="flex items-center justify-between mb-3 gap-3">
  <!-- Spoke filter dropdown -->
  <select name="server"
          hx-get="/api/history"
          hx-target="#history"
          hx-swap="innerHTML"
          hx-trigger="change"
          hx-include="this"
          class="bg-gray-700 border border-gray-600 text-gray-200 text-xs rounded-md px-3 py-1.5
                 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent
                 transition-colors min-w-0">
    <option value="" {% if not selected_server %}selected{% endif %}>All spokes</option>
    {% for spoke in spokes %}
    <option value="{{ spoke.name }}" {% if selected_server == spoke.name %}selected{% endif %}>
      {{ spoke.name }}
    </option>
    {% endfor %}
  </select>

  <!-- Clear button -->
  <button
    hx-delete="/api/history"
    hx-target="#history"
    hx-swap="innerHTML"
    hx-include="select[name='server']"
    hx-confirm="Clear sync history?"
    class="flex-shrink-0 flex items-center gap-1.5 border border-red-700 text-red-400
           hover:bg-red-900/30 hover:text-red-300 text-xs font-medium rounded-md px-3 py-1.5
           transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2
           focus:ring-offset-gray-900">
    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"/>
    </svg>
    Clear
  </button>
</div>

<!-- Table content — targeted by dropdown change and clear button -->
<div id="history-content">
  {% if history %}
  <div class="overflow-x-auto rounded-lg border border-gray-700">
    <table class="w-full text-sm">
      <thead>
        <tr class="bg-gray-700/50 text-gray-400 text-xs uppercase tracking-wider">
          <th class="px-4 py-3 text-left font-medium">Result</th>
          <th class="px-4 py-3 text-left font-medium">Server</th>
          <th class="px-4 py-3 text-left font-medium">Type</th>
          <th class="px-4 py-3 text-left font-medium">Time</th>
          <th class="px-4 py-3 text-right font-medium">+Added</th>
          <th class="px-4 py-3 text-right font-medium">&minus;Removed</th>
          <th class="px-4 py-3 text-right font-medium">Conflicts</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-700">
        {% for run in history %}
        <tr class="hover:bg-gray-700/30 transition-colors {% if loop.index is odd %}bg-gray-800{% else %}bg-gray-800/60{% endif %}">

          <!-- Result badge -->
          <td class="px-4 py-3">
            {% if run.status == 'success' %}
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium
                           bg-green-900/50 text-green-300 border border-green-800">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5"/>
                </svg>
                ok
              </span>
            {% else %}
              {% if run.error %}
              <details class="group">
                <summary class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium
                                bg-red-900/50 text-red-300 border border-red-800 cursor-pointer list-none
                                hover:bg-red-900/70 transition-colors"
                         title="{{ run.error }}">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
                  </svg>
                  error
                </summary>
                <p class="mt-1.5 text-gray-400 text-xs leading-relaxed break-words max-w-xs">
                  {{ run.error }}
                </p>
              </details>
              {% else %}
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium
                           bg-red-900/50 text-red-300 border border-red-800">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
                </svg>
                error
              </span>
              {% endif %}
            {% endif %}
          </td>

          <!-- Server name -->
          <td class="px-4 py-3 font-medium text-white">{{ run.server_name }}</td>

          <!-- Type badge -->
          <td class="px-4 py-3">
            <span class="px-1.5 py-0.5 rounded text-xs font-medium bg-blue-900/40 text-blue-300 uppercase tracking-wide">
              {{ run.server_type }}
            </span>
          </td>

          <!-- Timestamp: relative + absolute tooltip -->
          <td class="px-4 py-3 text-gray-400">
            <span data-ts="{{ run.started_at }}"
                  title="{{ run.started_at[:19] | replace('T', ' ') }} UTC"
                  class="text-gray-400"></span>
          </td>

          <!-- Stats -->
          <td class="px-4 py-3 text-right {% if run.added > 0 %}text-green-400 font-medium{% else %}text-gray-500{% endif %}">
            {{ run.added }}
          </td>
          <td class="px-4 py-3 text-right {% if run.removed > 0 %}text-red-400 font-medium{% else %}text-gray-500{% endif %}">
            {{ run.removed }}
          </td>
          <td class="px-4 py-3 text-right {% if run.conflicts > 0 %}text-yellow-400 font-medium{% else %}text-gray-500{% endif %}">
            {{ run.conflicts }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="text-gray-500 text-sm py-4">No sync runs yet.</p>
  {% endif %}
</div>
